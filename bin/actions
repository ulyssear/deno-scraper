#!/bin/sh

args=$(echo $@ | sed 's/\n/ /g')

executable=$(echo $args | grep -oP -- "--executable=\K.*?(?= --|$)")
browser=$(echo $args | grep -oP -- "--browser=\K.*?(?= --|$)")
headless=$(echo $args | grep -oP -- "--headless=\K.*?(?= --|$)")


chmod +x bin/run

incrementer=100
start=0
end=$incrementer

if [ -z "$executable" ]
then
    executable="metacritic"
fi

if [ -z "$browser" ]
then
    browser="chrome"
fi

if [ -z "$headless" ]
then
    headless="true"
fi

while true
do
    start_command_time=$(date +%s)
    echo "Start: $start"
    echo "End: $end"
    echo "Incrementer: $incrementer"
    echo "Running command: ./bin/run --no-interaction --browser=$browser --headless=$headless --executable=$executable --start=$start --end=$end"
    ./bin/run --no-interaction --browser=$browser --headless=$headless --executable=$executable --start=$start --end=$end
    start=$((start+incrementer))
    end=$((end+incrementer))
    end_command_time=$(date +%s)
    command_time=$((end_command_time-start_command_time))
    echo "Command time: $command_time"
    
    if [ $command_time -lt 30 ]
    then
        echo "Command time is less than 30 seconds, sleeping for 60 seconds"
        break
    fi

    sleep 30

done